# Dockerfile.slim
# ===== STAGE 1: Builder (встановлюємо все, збираємо модель) =====
FROM python:3.10-slim AS builder
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
WORKDIR /app

# Системні залежності (мінімум для коліс PyTorch)
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
 && rm -rf /var/lib/apt/lists/*

COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

COPY export_model.py ./
RUN python export_model.py --model mobilenet_v2 --out /app/model.pt

# ===== STAGE 2: Runtime (лише потрібні файли) =====
FROM python:3.10-slim AS runtime
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
WORKDIR /app

# Копіюємо лише встановлені пакети з builder (site-packages)
# ВАЖЛИВО: шлях має відповідати версії Python базового образу
COPY --from=builder /usr/local/lib/python3.10/site-packages/ /usr/local/lib/python3.10/site-packages/
# (Опційно) якщо щось встановилось у dist-packages:
# COPY --from=builder /usr/local/lib/python3.10/dist-packages/ /usr/local/lib/python3.10/dist-packages/

# Кладемо лише інференс-скрипт, модель і лейбли
COPY inference.py imagenet_class_index.json ./
COPY --from=builder /app/model.pt ./model.pt

ENTRYPOINT ["python", "inference.py"]
